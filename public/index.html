<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CodeAI</title>
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/@stackblitz/sdk/bundles/sdk.umd.js"></script>
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    :root {
      --bg: #0f0f0f; --surface: #1a1a1a; --surface2: #222;
      --border: #2a2a2a; --accent: #4f46e5; --text: #f0f0f0;
      --text-muted: #666; --green: #22c55e;
      --sans: 'Inter', sans-serif; --mono: 'JetBrains Mono', monospace;
    }
    body { background: var(--bg); color: var(--text); font-family: var(--sans); height: 100vh; display: flex; flex-direction: column; overflow: hidden; }

    /* HEADER */
    header { display: flex; align-items: center; justify-content: space-between; padding: 0 16px; height: 48px; border-bottom: 1px solid var(--border); background: var(--surface); flex-shrink: 0; }
    .logo { font-size: 15px; font-weight: 700; background: linear-gradient(90deg, #6366f1, #a855f7); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
    .header-right { display: flex; align-items: center; gap: 8px; }
    .badge { border-radius: 6px; padding: 3px 8px; font-size: 11px; font-family: var(--mono); color: #fff; font-weight: 600; background: linear-gradient(135deg, #cc785c, #e8956d); }
    .status-dot { width: 7px; height: 7px; border-radius: 50%; background: var(--green); box-shadow: 0 0 6px var(--green); }

    /* WORKSPACE */
    .workspace { display: flex; flex: 1; overflow: hidden; }

    /* LEFT CHAT */
    .chat-panel { width: 300px; flex-shrink: 0; display: flex; flex-direction: column; border-right: 1px solid var(--border); background: var(--surface); }
    .chat-header { padding: 10px 16px; border-bottom: 1px solid var(--border); font-size: 11px; font-weight: 600; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.08em; }
    .chat-messages { flex: 1; overflow-y: auto; padding: 10px; display: flex; flex-direction: column; gap: 8px; }
    .chat-messages::-webkit-scrollbar { width: 3px; }
    .chat-messages::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }
    .msg { font-size: 13px; line-height: 1.55; padding: 9px 12px; border-radius: 12px; word-break: break-word; }
    .msg.user { background: var(--accent); color: #fff; align-self: flex-end; border-bottom-right-radius: 4px; max-width: 88%; }
    .msg.ai { background: var(--surface2); color: var(--text); align-self: flex-start; border-bottom-left-radius: 4px; border: 1px solid var(--border); max-width: 100%; }
    .msg.ai.loading { color: var(--text-muted); font-style: italic; }
    .msg.thinking { background: #1a1a2e; border-color: #4f46e5; color: #818cf8; font-size: 12px; }

    .suggestions { display: flex; flex-wrap: wrap; gap: 5px; padding: 8px 10px; border-top: 1px solid var(--border); }
    .suggestion-btn { background: var(--surface2); border: 1px solid var(--border); border-radius: 20px; padding: 4px 10px; font-size: 11px; color: var(--text-muted); cursor: pointer; transition: all 0.2s; white-space: nowrap; font-family: var(--sans); }
    .suggestion-btn:hover { border-color: var(--accent); color: var(--text); }

    .img-preview-row { display: flex; align-items: center; gap: 8px; padding: 6px 10px; background: var(--surface2); border-top: 1px solid var(--border); flex-shrink: 0; }
    .img-preview-row.hidden { display: none; }
    .img-preview-thumb { width: 34px; height: 34px; object-fit: cover; border-radius: 6px; border: 1px solid var(--border); }
    .img-preview-name { font-size: 11px; color: var(--text-muted); font-family: var(--mono); flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .img-preview-remove { background: none; border: none; color: var(--text-muted); cursor: pointer; font-size: 14px; padding: 2px 6px; }

    .chat-input-row { display: flex; gap: 6px; padding: 8px 10px; border-top: 1px solid var(--border); background: var(--surface); align-items: flex-end; }
    .chat-input { flex: 1; background: var(--bg); border: 1px solid var(--border); border-radius: 10px; padding: 8px 12px; font-family: var(--sans); font-size: 13px; color: var(--text); outline: none; transition: border-color 0.2s; resize: none; max-height: 120px; line-height: 1.4; }
    .chat-input:focus { border-color: var(--accent); }
    .chat-input::placeholder { color: var(--text-muted); }
    .img-btn { background: var(--surface2); border: 1px solid var(--border); border-radius: 8px; padding: 8px 10px; color: var(--text-muted); font-size: 14px; cursor: pointer; transition: all 0.2s; flex-shrink: 0; }
    .img-btn:hover { border-color: #cc785c; color: #cc785c; }
    .send-btn { background: var(--accent); border: none; border-radius: 8px; padding: 9px 14px; color: #fff; font-size: 14px; font-weight: 600; cursor: pointer; transition: opacity 0.2s; flex-shrink: 0; }
    .send-btn:hover { opacity: 0.85; }
    .send-btn:disabled { opacity: 0.4; cursor: not-allowed; }
    #imageInput { display: none; }

    /* RIGHT PANEL */
    .right-panel { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
    .right-topbar { display: flex; align-items: center; justify-content: space-between; padding: 0 14px; height: 44px; border-bottom: 1px solid var(--border); background: var(--surface); flex-shrink: 0; }
    .view-tabs { display: flex; gap: 2px; background: var(--bg); border-radius: 8px; padding: 3px; }
    .view-tab { padding: 4px 14px; border-radius: 6px; font-size: 12px; font-weight: 500; cursor: pointer; border: none; background: none; color: var(--text-muted); transition: all 0.2s; font-family: var(--sans); }
    .view-tab.active { background: var(--surface2); color: var(--text); }
    .topbar-right { display: flex; align-items: center; gap: 8px; }
    .topbar-btn { background: var(--surface2); border: 1px solid var(--border); border-radius: 6px; padding: 4px 12px; font-size: 12px; color: var(--text-muted); cursor: pointer; transition: all 0.2s; font-family: var(--sans); }
    .topbar-btn:hover { border-color: var(--accent); color: var(--text); }
    .status-bar { font-size: 11px; font-family: var(--mono); color: var(--text-muted); }

    /* STACKBLITZ EMBED */
    .stackblitz-area { flex: 1; position: relative; overflow: hidden; display: none; }
    .stackblitz-area.active { display: block; }
    #stackblitzEmbed { width: 100%; height: 100%; border: none; }

    /* EMPTY STATE */
    .empty-state { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 12px; color: var(--text-muted); }
    .empty-state.hidden { display: none; }
    .empty-icon { font-size: 48px; opacity: 0.15; }
    .empty-state h3 { font-size: 16px; font-weight: 600; }
    .empty-state p { font-size: 13px; opacity: 0.6; text-align: center; max-width: 280px; line-height: 1.5; }

    /* DROP OVERLAY */
    .drop-overlay { display: none; position: fixed; inset: 0; background: rgba(79,70,229,0.12); border: 3px dashed var(--accent); z-index: 100; align-items: center; justify-content: center; font-size: 20px; font-weight: 700; color: var(--accent); pointer-events: none; }
    .drop-overlay.active { display: flex; }

    /* LOADING OVERLAY */
    .loading-overlay { display: none; position: absolute; inset: 0; background: rgba(15,15,15,0.92); z-index: 50; flex-direction: column; align-items: center; justify-content: center; gap: 16px; }
    .loading-overlay.active { display: flex; }
    .loading-spinner { width: 40px; height: 40px; border: 3px solid var(--border); border-top-color: var(--accent); border-radius: 50%; animation: spin 0.8s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .loading-text { font-size: 13px; color: var(--text-muted); font-family: var(--mono); }
  </style>
</head>
<body>

<div class="drop-overlay" id="dropOverlay">üì∑ Solte a imagem aqui!</div>

<header>
  <div class="logo">‚ú¶ CodeAI</div>
  <div class="header-right">
    <div class="badge">Claude + StackBlitz</div>
    <div class="status-dot"></div>
  </div>
</header>

<div class="workspace">

  <!-- CHAT -->
  <div class="chat-panel">
    <div class="chat-header">Chat</div>
    <div class="chat-messages" id="chatMessages">
      <div class="msg ai">üëã Ol√°! Descreva o que quer criar e eu gero um projeto React completo com Vite + Tailwind rodando ao vivo!</div>
    </div>

    <div class="suggestions">
      <button class="suggestion-btn" onclick="useSuggestion('Crie uma landing page para uma cafeteria chamada Noir Caf√©, tema escuro e elegante')">‚òï Cafeteria</button>
      <button class="suggestion-btn" onclick="useSuggestion('Crie um dashboard moderno com cards de m√©tricas, gr√°ficos e sidebar')">üìä Dashboard</button>
      <button class="suggestion-btn" onclick="useSuggestion('Crie uma landing page para um est√∫dio de design com anima√ß√µes suaves')">‚ú® Est√∫dio</button>
      <button class="suggestion-btn" onclick="useSuggestion('Crie um portf√≥lio pessoal moderno com hero animado e se√ß√£o de projetos')">üë§ Portf√≥lio</button>
    </div>

    <div class="img-preview-row hidden" id="imgPreviewRow">
      <img class="img-preview-thumb" id="imgPreviewThumb" src="" alt="" />
      <span class="img-preview-name" id="imgPreviewName"></span>
      <button class="img-preview-remove" onclick="clearImage()">‚úï</button>
    </div>

    <div class="chat-input-row">
      <button class="img-btn" onclick="document.getElementById('imageInput').click()" title="Enviar imagem">üì∑</button>
      <input type="file" id="imageInput" accept="image/*" />
      <textarea class="chat-input" id="chatInput" placeholder="Descreva o que quer criar..." rows="1"></textarea>
      <button class="send-btn" id="sendBtn">‚Üë</button>
    </div>
  </div>

  <!-- RIGHT -->
  <div class="right-panel">
    <div class="right-topbar">
      <div class="view-tabs">
        <button class="view-tab active" id="tabPreview" onclick="switchView('preview')">üëÅ Preview</button>
        <button class="view-tab" id="tabCode" onclick="switchView('code')">‚ü®/‚ü© C√≥digo</button>
      </div>
      <div class="topbar-right">
        <span class="status-bar" id="statusBar">aguardando...</span>
        <button class="topbar-btn" id="openBtn" style="display:none" onclick="openInStackBlitz()">‚Üó Abrir no StackBlitz</button>
      </div>
    </div>

    <div class="empty-state" id="emptyState">
      <div class="empty-icon">‚¨°</div>
      <h3>Nenhum projeto ainda</h3>
      <p>Descreva o que quer criar no chat e a IA vai gerar um projeto React completo.</p>
    </div>

    <div class="stackblitz-area" id="stackblitzArea">
      <div class="loading-overlay active" id="loadingOverlay">
        <div class="loading-spinner"></div>
        <div class="loading-text" id="loadingText">Gerando projeto...</div>
      </div>
      <div id="stackblitzEmbed"></div>
    </div>
  </div>
</div>

<script>
  const chatMessages = document.getElementById('chatMessages');
  const chatInput = document.getElementById('chatInput');
  const sendBtn = document.getElementById('sendBtn');
  const imageInput = document.getElementById('imageInput');
  const statusBar = document.getElementById('statusBar');
  const emptyState = document.getElementById('emptyState');
  const stackblitzArea = document.getElementById('stackblitzArea');
  const loadingOverlay = document.getElementById('loadingOverlay');
  const loadingText = document.getElementById('loadingText');
  const openBtn = document.getElementById('openBtn');

  let currentImage = null;
  let currentProject = null; // stores generated files
  let currentView = 'preview';

  // Auto-resize textarea
  chatInput.addEventListener('input', () => {
    chatInput.style.height = 'auto';
    chatInput.style.height = Math.min(chatInput.scrollHeight, 120) + 'px';
  });

  // Image handling
  imageInput.addEventListener('change', e => { if (e.target.files[0]) loadImage(e.target.files[0]); imageInput.value = ''; });

  function loadImage(file) {
    const reader = new FileReader();
    reader.onload = e => {
      currentImage = { base64: e.target.result.split(',')[1], mediaType: file.type || 'image/png', name: file.name };
      document.getElementById('imgPreviewThumb').src = e.target.result;
      document.getElementById('imgPreviewName').textContent = file.name;
      document.getElementById('imgPreviewRow').classList.remove('hidden');
      chatInput.focus();
    };
    reader.readAsDataURL(file);
  }

  function clearImage() {
    currentImage = null;
    document.getElementById('imgPreviewRow').classList.add('hidden');
  }

  // Drag & drop
  document.addEventListener('dragover', e => { e.preventDefault(); document.getElementById('dropOverlay').classList.add('active'); });
  document.addEventListener('dragleave', e => { if (!e.relatedTarget) document.getElementById('dropOverlay').classList.remove('active'); });
  document.addEventListener('drop', e => {
    e.preventDefault();
    document.getElementById('dropOverlay').classList.remove('active');
    const file = e.dataTransfer.files[0];
    if (file && file.type.startsWith('image/')) loadImage(file);
  });

  // Paste image
  document.addEventListener('paste', e => {
    const items = e.clipboardData?.items;
    if (!items) return;
    for (const item of items) {
      if (item.type.startsWith('image/')) { loadImage(item.getAsFile()); break; }
    }
  });

  function addMessage(text, type) {
    const msg = document.createElement('div');
    msg.className = `msg ${type}`;
    msg.textContent = text;
    chatMessages.appendChild(msg);
    chatMessages.scrollTop = chatMessages.scrollHeight;
    return msg;
  }

  function useSuggestion(text) {
    chatInput.value = text;
    chatInput.style.height = 'auto';
    sendMessage();
  }

  // LAUNCH STACKBLITZ
  function launchStackBlitz(files) {
    currentProject = files;
    emptyState.classList.add('hidden');
    stackblitzArea.classList.add('active');
    loadingOverlay.classList.add('active');
    loadingText.textContent = 'Iniciando StackBlitz...';

    // Clear previous embed
    document.getElementById('stackblitzEmbed').innerHTML = '';

    const project = {
      title: 'CodeAI Project',
      description: 'Generated by CodeAI',
      template: 'node',
      files: files
    };

    StackBlitzSDK.embedProject('stackblitzEmbed', project, {
      openFile: currentView === 'code' ? 'src/App.tsx' : undefined,
      view: currentView === 'code' ? 'editor' : 'preview',
      hideNavigation: false,
      hideDevTools: false,
      height: '100%',
    }).then(() => {
      loadingOverlay.classList.remove('active');
      statusBar.textContent = '‚óè ao vivo';
      statusBar.style.color = 'var(--green)';
      openBtn.style.display = 'block';
    }).catch(err => {
      loadingText.textContent = 'Erro ao carregar StackBlitz: ' + err.message;
    });
  }

  function openInStackBlitz() {
    if (!currentProject) return;
    StackBlitzSDK.openProject({
      title: 'CodeAI Project',
      template: 'node',
      files: currentProject
    });
  }

  function switchView(view) {
    currentView = view;
    document.getElementById('tabPreview').classList.toggle('active', view === 'preview');
    document.getElementById('tabCode').classList.toggle('active', view === 'code');

    // If project exists, reload with new view
    if (currentProject) launchStackBlitz(currentProject);
  }

  // SEND MESSAGE
  async function sendMessage() {
    const userMsg = chatInput.value.trim();
    if (!userMsg && !currentImage) return;

    const displayMsg = currentImage ? `üì∑ ${currentImage.name}${userMsg ? ' ‚Äî ' + userMsg : ''}` : userMsg;
    addMessage(displayMsg, 'user');
    chatInput.value = '';
    chatInput.style.height = 'auto';
    sendBtn.disabled = true;

    const loadingMsg = addMessage('‚ü≥ Gerando projeto React...', 'ai loading');
    statusBar.textContent = 'gerando...';
    statusBar.style.color = 'var(--text-muted)';

    // Show stackblitz area with loading
    emptyState.classList.add('hidden');
    stackblitzArea.classList.add('active');
    loadingOverlay.classList.add('active');
    loadingText.textContent = 'Claude est√° gerando o projeto...';

    try {
      let files;

      if (currentImage) {
        const imageData = { ...currentImage };
        clearImage();
        const prompt = userMsg || 'Analise este design e recrie como um projeto React com Tailwind.';
        const response = await fetch('/api/image', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ image: imageData.base64, mediaType: imageData.mediaType, prompt, mode: 'react' })
        });
        if (!response.ok) { const e = await response.json(); throw new Error(e.error); }
        const data = await response.json();
        files = data.files;
      } else {
        const response = await fetch('/api/generate', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ prompt: userMsg, currentFiles: currentProject })
        });
        if (!response.ok) { const e = await response.json(); throw new Error(e.error); }
        const data = await response.json();
        files = data.files;
      }

      loadingText.textContent = 'Iniciando StackBlitz...';
      launchStackBlitz(files);

      loadingMsg.textContent = '‚úì Projeto gerado! Veja o preview ‚Üí';
      loadingMsg.className = 'msg ai';

    } catch (err) {
      loadingMsg.textContent = `‚úó Erro: ${err.message}`;
      loadingMsg.className = 'msg ai';
      loadingOverlay.classList.remove('active');
      statusBar.textContent = 'erro';
      statusBar.style.color = '#ef4444';
    }

    sendBtn.disabled = false;
  }

  sendBtn.addEventListener('click', sendMessage);
  chatInput.addEventListener('keydown', e => {
    if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); }
  });
</script>
</body>
</html>
